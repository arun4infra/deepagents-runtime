name: Test GitHub App Token

on:
  workflow_dispatch:

jobs:
  test-token:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: bizmatters
          repositories: deepagents-runtime,spec-engine,zerotouch-tenants
      
      - name: Checkout service repo
        uses: actions/checkout@v4
      
      - name: Checkout platform repo
        uses: actions/checkout@v4
        with:
          repository: arun4infra/zerotouch-platform
          path: zerotouch-platform
          ref: main
      
      - name: Test checkout script
        env:
          BOT_GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "Token length: ${#BOT_GITHUB_TOKEN}"
          
          chmod +x ./zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/checkout-pr-claims.sh
          ./zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/checkout-pr-claims.sh pr intelligence-deepagents $(pwd)
          
          if [ -d "platform/deepagents-runtime" ]; then
            echo "✅ SUCCESS: PR claims checked out"
            ls -la platform/deepagents-runtime/overlays/pr/
          else
            echo "❌ FAILED"
            exit 1
          fi
