Metadata-Version: 2.4
Name: agent_executor
Version: 0.1.0
Summary: Serverless LangGraph Agent Execution Service
Author: Bizmatters Team
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: fastapi>=0.115.0
Requires-Dist: uvicorn[standard]>=0.32.0
Requires-Dist: nats-py>=2.9.0
Requires-Dist: deepagents>=0.2.7
Requires-Dist: langgraph>=1.0.0
Requires-Dist: langgraph-checkpoint-postgres>=3.0.0
Requires-Dist: langchain>=1.0.0
Requires-Dist: langchain-openai>=0.3.0
Requires-Dist: langchain-anthropic>=1.0.0
Requires-Dist: langsmith>=0.2.0
Requires-Dist: psycopg[binary,pool]>=3.2.0
Requires-Dist: redis>=5.2.0
Requires-Dist: cloudevents>=1.11.0
Requires-Dist: pydantic>=2.10.0
Requires-Dist: pydantic-settings>=2.1.0
Requires-Dist: structlog>=24.4.0
Requires-Dist: opentelemetry-api>=1.28.2
Requires-Dist: opentelemetry-sdk>=1.28.2
Requires-Dist: opentelemetry-instrumentation-fastapi>=0.49b2
Requires-Dist: opentelemetry-exporter-otlp>=1.28.2
Requires-Dist: httpx>=0.27.2
Requires-Dist: prometheus-client>=0.19.0
Requires-Dist: python-dotenv>=1.0.0
Requires-Dist: jsonschema>=4.23.0
Provides-Extra: dev
Requires-Dist: pytest>=8.3.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.24.0; extra == "dev"
Requires-Dist: pytest-mock>=3.14.0; extra == "dev"
Requires-Dist: pytest-cov>=4.1.0; extra == "dev"
Requires-Dist: pytest-timeout>=2.3.0; extra == "dev"
Requires-Dist: black>=24.1.1; extra == "dev"
Requires-Dist: ruff>=0.1.13; extra == "dev"
Requires-Dist: mypy>=1.8.0; extra == "dev"
Requires-Dist: types-redis>=4.6.0; extra == "dev"

# deepagnets-runtime

Event-driven Python service for secure and stateful execution of LangGraph agents in Kubernetes with KEDA autoscaling.

## Overview

- **Event Processing**: NATS JetStream + KEDA autoscaling (1-10 pods)
- **State Persistence**: PostgreSQL + LangGraph Checkpointer
- **Real-time Streaming**: Dragonfly (Redis-compatible)
- **Secret Management**: External Secrets Operator (ESO) syncs from AWS Parameter Store
- **Database Provisioning**: Crossplane auto-generates PostgreSQL and Dragonfly
- **Deployment**: GitOps via ArgoCD (no manual kubectl)

## Quick Start

### Local Development

```bash
# Install dependencies
uv sync --all-extras

# Configure environment
cp .env.example .env
# Edit .env with your local credentials

# Run service
uv run uvicorn api.main:app --reload --port 8080

# Run tests
uv run pytest
```

### Production Deployment (GitOps)

```bash
# 1. Update claims in platform/claims/intelligence-deepagents/
# 2. Commit and push to Git
git add platform/claims/
git commit -m "feat: update deepagnets-runtime"
git push origin main

# 3. ArgoCD syncs automatically
# 4. Verify deployment
kubectl get deployment deepagnets-runtime -n intelligence-deepagents
kubectl get scaledobject -n intelligence-deepagents
```

## Architecture

```
NATS JetStream → NATS Consumer → Parse CloudEvent → Build Graph → Execute → Emit Result
                                                          ↓
                                                    PostgreSQL (checkpoints)
                                                    Dragonfly (streaming)
```

**Namespace**: `intelligence-deepagents`  
**Scaling**: 1-10 pods based on NATS queue depth  
**Resources**: 500m-2000m CPU, 1-4Gi memory per pod

## Configuration

### Environment Variables (Production)

Secrets auto-injected via ESO and Crossplane:

- `OPENAI_API_KEY`, `ANTHROPIC_API_KEY` - From ESO (AWS Parameter Store)
- `PG_HOST`, `PG_PORT`, `PG_USER`, `PG_PASSWORD`, `PG_DATABASE` - From Crossplane secret
- `REDIS_HOST`, `REDIS_PORT` - From Crossplane secret
- `NATS_URL`, `NATS_STREAM_NAME`, `NATS_CONSUMER_GROUP` - From EventDrivenService

### Secret Management

**LLM API Keys** (via ESO):
```bash
# AWS SSM Parameters
/zerotouch/prod/agent-executor/openai_api_key
/zerotouch/prod/agent-executor/anthropic_api_key

# ESO syncs to Kubernetes Secret: agent-executor-llm-keys
```

**Database Credentials** (via Crossplane):
```bash
agent-executor-db-conn        # PostgreSQL (auto-generated)
agent-executor-cache-conn     # Dragonfly (auto-generated)
```

## Platform Integration

### Claims Structure

```
platform/claims/intelligence-deepagents/
├── postgres-claim.yaml              # PostgreSQL database
├── dragonfly-claim.yaml             # Dragonfly cache
├── external-secrets/
│   └── llm-keys-es.yaml            # LLM API keys (ESO)
└── agent-executor-deployment.yaml   # EventDrivenService claim
```

### KEDA Autoscaling

- **Trigger**: NATS JetStream consumer lag
- **Threshold**: 5 messages per pod
- **Min/Max**: 1-10 pods

## Development

```bash
# Code quality
uv run black .
uv run ruff check .
uv run mypy .

# Testing
uv run pytest tests/unit/          # Unit tests
uv run pytest tests/integration/   # Integration tests
uv run pytest --cov                # With coverage
```

## References

- [Platform Architecture](../zerotouch-platform/README.md)
- [External Secrets Operator](https://external-secrets.io/)
- [Crossplane](https://docs.crossplane.io/)
- [KEDA](https://keda.sh/)
- [LangGraph](https://python.langchain.com/docs/langgraph)
